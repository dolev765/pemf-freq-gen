<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<script>
		if (window.matchMedia && window.matchMedia('(max-device-width: 390px)').matches) {
			viewport = document.querySelector('meta[name=viewport]');
			if (viewport) viewport.setAttribute('content', 'width=390');
		}
	</script>
	<title>Online Tone Generator - generate pure tones of any frequency</title>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="tone-generator.mini.css?20">
	<style>
		#presets-section {
			margin: 40px 0;
			padding: 20px;
			background-color: rgba(255, 255, 255, 0.1);
			border-radius: 5px;
			border: solid 1px rgba(174, 98, 41, 0.3);
		}

		#presets-section h2 {
			margin-top: 0;
			margin-bottom: 15px;
		}

		#presets-section h3 {
			font-size: 18px;
			color: #7a3400;
			margin-top: 20px;
			margin-bottom: 10px;
		}

		#presets-section h4 {
			font-size: 14px;
			color: #8e420b;
			margin-top: 15px;
			margin-bottom: 8px;
		}

		#device-selector {
			margin-bottom: 15px;
		}

		#presets-controls {
			margin-bottom: 20px;
		}

		#presets-list {
			margin-top: 15px;
		}

		.preset-item {
			background-color: rgba(251, 196, 157, 0.6);
			border: solid 1px #a55f2b;
			border-radius: 3px;
			padding: 12px;
			margin-bottom: 10px;
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			gap: 10px;
		}

		.preset-name {
			font-weight: 600;
			font-size: 15px;
			color: #7a3400;
			flex: 1;
			min-width: 150px;
		}

		.preset-details {
			font-size: 12px;
			color: #8e420b;
			flex: 2;
			min-width: 200px;
		}

		.preset-buttons {
			display: flex;
			gap: 8px;
		}

		.preset-buttons .small-button {
			width: auto;
			padding: 0 10px;
			min-width: 50px;
		}

		#preset-dialog {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 10000;
			display: none;
			align-items: center;
			justify-content: center;
		}

		.preset-dialog-content {
			background-color: #fbc49d;
			border-radius: 5px;
			padding: 25px;
			max-width: 500px;
			width: 90%;
			box-shadow: 0 0 33px 11px rgba(0, 0, 0, 0.25);
		}

		.preset-dialog-content h3 {
			margin-top: 0;
			margin-bottom: 20px;
			color: #7a3400;
		}

		.preset-form {
			display: flex;
			flex-direction: column;
			gap: 12px;
			margin-bottom: 20px;
		}

		.preset-form label {
			font-weight: 600;
			font-size: 13px;
			color: #7a3400;
			margin-bottom: 3px;
		}

		.preset-form input[type="text"],
		.preset-form input[type="number"],
		.preset-form select {
			padding: 8px;
			border: solid 1px #a55f2b;
			border-radius: 3px;
			background-color: #fff;
			font-family: "Open Sans", sans-serif;
			font-size: 14px;
			color: #000;
			width: 100%;
			box-sizing: border-box;
		}

		.preset-form input[type="text"]:focus,
		.preset-form input[type="number"]:focus,
		.preset-form select:focus {
			outline: none;
			border-color: #874e23;
			box-shadow: 0 0 5px rgba(135, 78, 35, 0.3);
		}

		#frequency-log-scale-box {
			display: none
		}

		button.active {
			background: #8e420b !important;
			color: #fff !important;
			box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.4) !important;
			border-color: #703308 !important;
		}

		.preset-dialog-buttons {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
		}

		.preset-dialog-buttons .button {
			padding: 8px 20px;
			font-size: 13px;
		}

		@media screen and (max-width: 701px) {
			.preset-item {
				flex-direction: column;
				align-items: flex-start;
			}

			.preset-name,
			.preset-details {
				width: 100%;
			}

			.preset-buttons {
				width: 100%;
				justify-content: flex-end;
			}
		}

		/* Phyphox Section Styles */
		#phyphox-section {
			margin: 20px 0;
			padding: 20px;
			background-color: rgba(255, 255, 255, 0.1);
			border-radius: 5px;
			border: solid 1px rgba(41, 128, 185, 0.3);
		}

		#phyphox-section h2 {
			margin-top: 0;
			margin-bottom: 15px;
			color: #2980b9;
		}

		.phyphox-controls-container {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
			align-items: flex-start;
		}

		.phyphox-panel {
			background-color: rgba(212, 230, 241, 0.6);
			border: solid 1px #2980b9;
			border-radius: 5px;
			padding: 15px;
			flex: 1;
			min-width: 280px;
		}

		.phyphox-panel h3 {
			margin-top: 0;
			margin-bottom: 10px;
			font-size: 16px;
			color: #1a5276;
		}

		.phyphox-input-group {
			margin-bottom: 12px;
		}

		.phyphox-input-group label {
			display: block;
			font-weight: 600;
			font-size: 13px;
			color: #1a5276;
			margin-bottom: 4px;
		}

		.phyphox-input-row {
			display: flex;
			gap: 8px;
		}

		.phyphox-input-row input {
			flex: 1;
			padding: 8px;
			border: solid 1px #2980b9;
			border-radius: 3px;
			font-size: 14px;
		}

		.phyphox-status {
			font-size: 12px;
			margin-top: 5px;
			font-weight: 600;
		}

		.status-disconnected {
			color: #7b241c;
		}

		.status-connecting {
			color: #7d6608;
		}

		.status-connected {
			color: #145a32;
		}

		.phyphox-display {
			text-align: center;
			padding: 10px;
			background-color: #fff;
			border-radius: 5px;
			border: solid 1px #2980b9;
			margin-bottom: 15px;
		}

		.mt-value {
			font-size: 32px;
			font-weight: bold;
			color: #1a5276;
		}

		.mt-label {
			font-size: 12px;
			color: #5499c7;
		}

		.auto-adapt-toggle {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-top: 10px;
			padding: 10px;
			background-color: rgba(41, 128, 185, 0.1);
			border-radius: 3px;
			cursor: pointer;
		}

		.auto-adapt-toggle input {
			width: 18px;
			height: 18px;
		}

		.auto-adapt-toggle span {
			font-weight: 600;
			font-size: 14px;
			color: #1a5276;
		}

		.auto-adapt-active {
			background-color: rgba(46, 204, 113, 0.2);
			border: solid 1px #27ae60;
		}
	</style>
	<link rel="shortcut icon" href="tone-generator-favicon.png">
	<link rel="apple-touch-icon" href="tone-generator-apple.png" sizes="180x180">
	<script src="frequency-generator.mini.js?23"></script>
	<script src="website/js/channel-splitter.js"></script>
	<script src="website/js/stereo-freq.js"></script>

	<script>
		// Auto Calculator for Micro Teslas
		var MicroTeslaCalculator = {
			// Calibration data based on measurements
			calibration: {
				mobile: {
					maxVolume: 100, // Android system volume at 100%
					maxMicroteslas: 7185, // Peak at 100% volume
					maxVoltage: 1.0, // Equivalent to PC 63%
					websiteSliderAtMax: 100 // Website slider at 100%
				},
				pc: {
					maxVolume: 63, // PC system volume at 63%
					maxMicroteslas: 7080, // Peak at 63% volume
					maxVoltage: 1.0,
					websiteSliderAtMax: 100
				}
			},

			// Known voltage/microtesla relationships
			voltageToMicroteslas: {
				0.22: 55, // Brain/Wit setting (PC 30%)
				0.44: 110, // Soccer Nerves (approximate)
				1.0: 7080 // Max PC setting
			},

			calculateWebsiteSlider: function (deviceType, targetMicroteslas) {
				var cal = this.calibration[deviceType];
				if (!cal || !targetMicroteslas || targetMicroteslas <= 0) {
					return null;
				}

				// Calculate ratio: target / max
				var ratio = targetMicroteslas / cal.maxMicroteslas;

				// Convert to website slider percentage (0-100)
				var sliderPercent = Math.round(ratio * 100 * 100) / 100; // Round to 2 decimals

				// Clamp between 1 and 100
				sliderPercent = Math.max(1, Math.min(100, sliderPercent));

				return sliderPercent;
			},

			// Quick routines for mobile
			routines: {
				brain: {
					freq: 40,
					websiteSlider: 47,
					microteslas: 55,
					voltage: 0.22,
					description: "Brain/Wit - Perfect 'Whisper' (55 μT)"
				},
				soccer: {
					freq: 1000,
					websiteSlider: 67,
					microteslas: 110,
					voltage: 0.44,
					description: "Soccer Nerves - Nerve Priming"
				},
				'safe-height': {
					freq: 28,
					websiteSlider: 95,
					microteslas: 6726,
					voltage: 0.95,
					description: "Safe Height - Growth Signal (matches PC 63%)"
				},
				'max-height': {
					freq: 28,
					websiteSlider: 100,
					microteslas: 7185,
					voltage: 1.0,
					description: "Max Height - Maximum Power"
				}
			},

			applyRoutine: function (routineName) {
				var routine = this.routines[routineName];
				if (!routine) return;

				// Set frequency
				if (routine.freq && window.setFreq) {
					window.setFreq(routine.freq);
				}

				// Set website volume slider
				if (routine.websiteSlider && window.setVolume) {
					window.setVolume(routine.websiteSlider / 100);
				}

				// Show notification
				var resultDiv = document.getElementById('calculator-result');
				if (resultDiv) {
					resultDiv.innerHTML = '✓ Applied: ' + routine.description + '<br>' +
						'Frequency: ' + routine.freq + ' Hz<br>' +
						'Website Slider: ' + routine.websiteSlider + '%<br>' +
						'Target: ' + routine.microteslas + ' μT';
				}
			}
		};

		// Default Presets (saved in code)
		var DefaultPresets = [
			{
				id: 'default-brain',
				name: 'Brain/Wit',
				deviceType: 'mobile',
				freq: 40,
				websiteVolume: 47,
				ampVolume: 50,
				pcVolume: 50,
				androidClicks: 0,
				microteslas: 55,
				isDefault: true
			},
			{
				id: 'default-soccer',
				name: 'Soccer Nerves',
				deviceType: 'mobile',
				freq: 1000,
				websiteVolume: 67,
				ampVolume: 50,
				pcVolume: 50,
				androidClicks: 0,
				microteslas: 110,
				isDefault: true
			},
			{
				id: 'default-safe-height',
				name: 'Safe Height',
				deviceType: 'mobile',
				freq: 28,
				websiteVolume: 95,
				ampVolume: 50,
				pcVolume: 50,
				androidClicks: 0,
				microteslas: 6726,
				isDefault: true
			},
			{
				id: 'default-max-height',
				name: 'Max Height',
				deviceType: 'mobile',
				freq: 28,
				websiteVolume: 100,
				ampVolume: 50,
				pcVolume: 50,
				androidClicks: 0,
				microteslas: 7185,
				isDefault: true
			},
			{
				id: 'default-architect',
				name: 'The Architect (Strategy)',
				deviceType: 'mobile',
				freq: 40,
				websiteVolume: 47,
				microteslas: 55,
				placement: '<b>Left:</b> 5cm up/2.5cm in from eye. <b>Right:</b> 7.5cm up/5cm back from ear.',
				description: 'Target: Logic + Vision. <b>Study Opt: 55 µT</b> (Cognitive Binding Window)',
				isDefault: true
			},
			{
				id: 'default-save-button',
				name: 'The Save Button (Fear Deletion)',
				deviceType: 'mobile',
				freq: 10,
				websiteVolume: 52,
				microteslas: 65,
				placement: '<b>Both:</b> 3cm directly above ear canal.',
				description: 'Target: Amygdala. <b>Study Opt: 65 µT</b> (Depth Penetration for Fear Mute)',
				isDefault: true
			},
			{
				id: 'default-god-orator-aggression',
				name: 'The God-Orator (Confidence)',
				deviceType: 'mobile',
				freq: 25,
				websiteVolume: 67,
				microteslas: 110,
				placement: '<b>Left:</b> Temple 2.5cm fwd/1cm down. <b>Right:</b> 5cm up/2.5cm in from eye.',
				description: 'Target: Speech + Confidence. <b>Study Opt: 110 µT</b> (Motor/Action Priming)',
				isDefault: true
			},
			{
				id: 'default-god-orator-speed',
				name: 'The God-Orator (Speed)',
				deviceType: 'mobile',
				freq: 40,
				websiteVolume: 67,
				microteslas: 110,
				placement: '<b>Left:</b> Temple 2.5cm fwd/1cm down. <b>Right:</b> 5cm up/2.5cm in from eye.',
				description: 'Target: Speech + Confidence. <b>Study Opt: 110 µT</b> (High-Speed Binding)',
				isDefault: true
			},
			{
				id: 'default-pivot',
				name: 'The Pivot (Creativity)',
				deviceType: 'mobile',
				freq: 40,
				websiteVolume: 47,
				microteslas: 55,
				placement: '<b>Left:</b> Temple (same). <b>Right:</b> 2.5cm up/5cm back from ear.',
				description: 'Target: Speech + Creativity. <b>Study Opt: 55 µT</b> (Plasticity Window)',
				isDefault: true
			}
		];

		// Presets Management
		var PresetsManager = {
			storageKey: 'toneGeneratorPresets',
			defaultPresetsKey: 'toneGeneratorDefaultPresets',

			getDefaultPresets: function () { return DefaultPresets; },
			getUserPresets: function () {
				var stored = localStorage.getItem(this.storageKey);
				return stored ? JSON.parse(stored) : [];
			},
			getAllPresets: function () {
				return this.getDefaultPresets().concat(this.getUserPresets());
			},
			getPresets: function () { return this.getAllPresets(); },

			addPreset: function (preset) {
				var userPresets = this.getUserPresets();
				preset.id = Date.now().toString();
				preset.isDefault = false;
				userPresets.push(preset);
				this.saveUserPresets(userPresets);
				this.renderPresets();
			},

			saveUserPresets: function (presets) {
				localStorage.setItem(this.storageKey, JSON.stringify(presets));
			},

			deletePreset: function (id) {
				var userPresets = this.getUserPresets();
				userPresets = userPresets.filter(function (p) { return p.id !== id; });
				this.saveUserPresets(userPresets);
				this.renderPresets();
			},

			loadPreset: function (preset) {
				if (preset.freq) window.setFreq(preset.freq);
				if (preset.websiteVolume !== undefined) window.setVolume(preset.websiteVolume / 100);
			},

			exportPresetsAsCode: function () {
				var userPresets = this.getUserPresets();
				if (userPresets.length === 0) { alert('No user presets.'); return; }
				var code = '// User Presets\nvar UserPresets = ' + JSON.stringify(userPresets, null, 2) + ';\n';
				var blob = new Blob([code], { type: 'text/javascript' });
				var a = document.createElement('a');
				a.href = URL.createObjectURL(blob);
				a.download = 'user-presets.js';
				a.click();
			},

			importPresetsFromCode: function (code) {
				try {
					var presets = [];
					var match = code.match(/\[[\s\S]*\]/);
					if (match) {
						presets = JSON.parse(match[0]);
						var existing = this.getUserPresets();
						var existingIds = existing.map(function (p) { return p.id; });
						presets.forEach(function (p) {
							if (!existingIds.includes(p.id)) {
								p.isDefault = false;
								existing.push(p);
							}
						});
						this.saveUserPresets(existing);
						this.renderPresets();
						alert('Imported ' + presets.length + ' preset(s).');
					}
				} catch (e) {
					alert('Error importing presets: ' + e.message);
				}
			},

			renderPresets: function () {
				var defaults = this.getDefaultPresets();
				var userPresets = this.getUserPresets();
				var list = document.getElementById('presets-list');
				if (!list) return;
				list.innerHTML = '';

				if (defaults.length === 0 && userPresets.length === 0) {
					list.innerHTML = '<p style="color: #8e420b; font-style: italic;">No presets saved yet.</p>';
					return;
				}

				if (defaults.length > 0) {
					var header = document.createElement('div');
					header.style.cssText = 'font-weight: 600; color: #7a3400; margin-top: 10px; margin-bottom: 5px; font-size: 14px;';
					header.textContent = 'Default Presets';
					list.appendChild(header);
					defaults.forEach(p => this.renderPresetItem(p, list, true));
				}

				if (userPresets.length > 0) {
					var header = document.createElement('div');
					header.style.cssText = 'font-weight: 600; color: #7a3400; margin-top: 15px; margin-bottom: 5px; font-size: 14px;';
					header.textContent = 'Your Presets';
					list.appendChild(header);
					userPresets.forEach(p => this.renderPresetItem(p, list, false));
				}
			},

			renderPresetItem: function (preset, list, isDefault) {
				var presetDiv = document.createElement('div');
				presetDiv.className = 'preset-item';
				if (isDefault) presetDiv.style.borderLeft = '3px solid #874e23';

				var name = document.createElement('div');
				name.className = 'preset-name';
				name.textContent = preset.name || 'Unnamed';

				var details = document.createElement('div');
				details.className = 'preset-details';
				var detailsText = [];
				if (preset.freq) detailsText.push(preset.freq.toFixed(2) + ' Hz');
				if (preset.websiteVolume !== undefined) detailsText.push('Vol: ' + preset.websiteVolume + '%');
				if (preset.microteslas) detailsText.push(preset.microteslas + ' μT');

				var detailsHtml = detailsText.join(' | ');
				if (preset.description) {
					detailsHtml += '<br><span style="font-size:11px; opacity:0.8; font-style:italic;">' + preset.description + '</span>';
				}
				if (preset.placement) {
					detailsHtml += '<br><span style="font-size:11px; color:#a04000; display:block; margin-top:3px;">' + preset.placement + '</span>';
				}
				details.innerHTML = detailsHtml;

				var buttons = document.createElement('div');
				buttons.className = 'preset-buttons';

				var loadBtn = document.createElement('button');
				loadBtn.className = 'small-button';
				loadBtn.textContent = 'Load';
				loadBtn.onclick = () => this.loadPreset(preset);
				buttons.appendChild(loadBtn);

				if (!isDefault) {
					var delBtn = document.createElement('button');
					delBtn.className = 'small-button';
					delBtn.textContent = 'Delete';
					delBtn.onclick = () => {
						if (confirm('Delete preset?')) this.deletePreset(preset.id);
					};
					buttons.appendChild(delBtn);
				}

				presetDiv.appendChild(name);
				presetDiv.appendChild(details);
				presetDiv.appendChild(buttons);
				list.appendChild(presetDiv);
			},

			showCreateDialog: function () {
				var dialog = document.getElementById('preset-dialog');
				if (dialog) {
					dialog.style.display = 'flex';
					var input = document.getElementById('preset-name-input');
					if (input) {
						input.value = '';
						input.focus();
					}
				}
			},

			hideCreateDialog: function () {
				var dialog = document.getElementById('preset-dialog');
				if (dialog) dialog.style.display = 'none';
			},

			savePresetFromDialog: function () {
				var input = document.getElementById('preset-name-input');
				if (!input || !input.value.trim()) return;
				this.addPreset({
					name: input.value.trim(),
					freq: window.sliderFreq || 440,
					websiteVolume: Math.round((window.volume || 0.5) * 100)
				});
				this.hideCreateDialog();
			}
		};

		// Phyphox Integration
		var PhyphoxManager = {
			ip: '',
			prefix: '192.168.1.',
			code: '',
			isConnected: false,
			isAutoAdapt: false,
			fetchInterval: null,
			currentMicroteslas: 0,
			peakMicroteslas: 0,
			peakBuffer: [], // Rolling window for peak detection
			peakWindowSize: 15, // Approx 1.5-2 seconds at 100-200ms polling
			targetMicroteslas: 0,
			adaptationStep: 0.002, // Finer control
			targetReachedTime: null,
			holdDuration: 2000,

			init: function () {
				var savedPrefix = localStorage.getItem('phyphoxPrefix');
				if (savedPrefix) {
					this.prefix = savedPrefix;
					var prefixInput = document.getElementById('phyphox-prefix');
					if (prefixInput) prefixInput.value = savedPrefix;
				}
				var savedCode = localStorage.getItem('phyphoxCode');
				if (savedCode) {
					this.code = savedCode;
					var codeInput = document.getElementById('phyphox-code');
					if (codeInput) codeInput.value = savedCode;
				}
				var savedTarget = localStorage.getItem('phyphoxTargetMT');
				if (savedTarget) {
					this.targetMicroteslas = parseFloat(savedTarget);
					var targetInput = document.getElementById('target-mt');
					if (targetInput) targetInput.value = savedTarget;
				}
			},

			connect: function () {
				var codeInput = document.getElementById('phyphox-code');
				var prefixInput = document.getElementById('phyphox-prefix');
				if (!codeInput || !prefixInput) return;

				var rawPrefix = prefixInput.value.trim();
				var rawCode = codeInput.value.trim();

				var fullIpMatch = rawPrefix.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(:\d+)?/);
				if (fullIpMatch && rawPrefix.length > 12) {
					this.ip = rawPrefix;
					if (!this.ip.includes(':')) this.ip += ':8080';
					this.code = "MANUAL";
					localStorage.setItem('phyphoxPrefix', rawPrefix);
				} else {
					if (!rawCode) {
						alert('Please enter the connection code shown in the app.');
						return;
					}
					this.code = rawCode;
					this.prefix = rawPrefix;
					if (!this.prefix.endsWith('.') && this.prefix.split('.').length === 3) {
						this.prefix += '.';
					}
					this.ip = this.prefix + parseInt(this.code, 10) + ':8080';
					localStorage.setItem('phyphoxCode', this.code);
					localStorage.setItem('phyphoxPrefix', this.prefix);
				}

				this.updateStatus('connecting', 'Connecting to ' + this.ip + '...');
				this.peakBuffer = []; // Reset peak detection on connect

				if (this.fetchInterval) clearInterval(this.fetchInterval);
				this.fetchInterval = setInterval(() => this.fetchData(), 120); // Faster polling for better peak detection

				this.isConnected = true;
			},

			disconnect: function () {
				if (this.fetchInterval) {
					clearInterval(this.fetchInterval);
					this.fetchInterval = null;
				}
				this.isConnected = false;
				this.updateStatus('disconnected', 'Disconnected');
				this.currentMicroteslas = 0;
				this.peakMicroteslas = 0;
				this.peakBuffer = []; // Clear buffer 
				this.updateDisplay();
			},

			updateStatus: function (status, message) {
				var statusEl = document.getElementById('phyphox-status');
				if (!statusEl) return;
				statusEl.className = 'phyphox-status status-' + status;
				statusEl.textContent = message;

				var connBtn = document.getElementById('phyphox-connect-btn');
				if (connBtn) {
					connBtn.textContent = (status === 'disconnected') ? 'Connect' : 'Disconnect';
					connBtn.onclick = (status === 'disconnected') ? () => this.connect() : () => this.disconnect();
				}
			},

			fetchData: function () {
				var baseUrl = this.ip;
				if (!baseUrl.startsWith('http')) baseUrl = 'http://' + baseUrl;
				if (!baseUrl.endsWith('/')) baseUrl += '/';

				var url = baseUrl + 'get?magnetometer';
				if (this.targetMicroteslas > 0) {
					url += '&target=' + this.targetMicroteslas;
				}

				fetch(url)
					.then(response => response.json())
					.then(data => {
						if (data && data.buffer && data.buffer.magnetometer) {
							var buffer = data.buffer.magnetometer;
							if (buffer.value && buffer.value.length >= 3) {
								var x = buffer.value[0][buffer.value[0].length - 1] || 0;
								var y = buffer.value[1][buffer.value[1].length - 1] || 0;
								var z = buffer.value[2][buffer.value[2].length - 1] || 0;

								var reading = Math.sqrt(x * x + y * y + z * z);
								this.currentMicroteslas = reading;

								// Peak detection logic: keep high values in a window
								this.peakBuffer.push(reading);
								if (this.peakBuffer.length > this.peakWindowSize) {
									this.peakBuffer.shift();
								}
								this.peakMicroteslas = Math.max(...this.peakBuffer);

								this.updateStatus('connected', 'Connected');
								this.updateDisplay();

								if (this.isAutoAdapt) {
									this.doAdaptation();
								}
							}
						}
					})
					.catch(err => {
						this.updateStatus('connecting', 'Retrying...');
					});
			},

			updateDisplay: function () {
				var display = document.getElementById('current-mt-display');
				if (display) {
					display.textContent = this.currentMicroteslas.toFixed(1);
				}
				// Optional: display peak as well if element exists
				var peakDisplay = document.getElementById('peak-mt-display');
				if (peakDisplay) {
					peakDisplay.textContent = this.peakMicroteslas.toFixed(1);
				}
			},

			setTarget: function (val) {
				this.targetMicroteslas = parseFloat(val) || 0;
				localStorage.setItem('phyphoxTargetMT', this.targetMicroteslas);
			},

			setAutoAdapt: function (val) {
				this.isAutoAdapt = val;
				if (val) {
					this.peakBuffer = []; // Reset window to ensure fresh start
				} else {
					this.targetReachedTime = null;
				}
				var label = document.getElementById('auto-adapt-label');
				var container = document.getElementById('auto-adapt-container');
				var checkbox = document.getElementById('auto-adapt-checkbox');
				if (checkbox) checkbox.checked = this.isAutoAdapt;
				if (this.isAutoAdapt) {
					if (label) label.textContent = 'Auto-Adapt: ON';
					if (container) container.classList.add('auto-adapt-active');
				} else {
					if (label) label.textContent = 'Auto-Adapt: OFF';
					if (container) container.classList.remove('auto-adapt-active');
				}
			},

			toggleAutoAdapt: function () {
				this.setAutoAdapt(!this.isAutoAdapt);
			},

			doAdaptation: function () {
				if (!window.tones || !tones.playing || this.targetMicroteslas <= 0) return;

				var currentVol = window.volume || 0;
				var diff = this.targetMicroteslas - this.peakMicroteslas; // Target the PEAK, not current
				var deadband = Math.max(1.5, this.targetMicroteslas * 0.01); // 1% tolerance

				if (Math.abs(diff) < deadband) {
					var now = Date.now();
					if (this.targetReachedTime === null) {
						this.targetReachedTime = now;
					} else if (now - this.targetReachedTime >= this.holdDuration) {
						this.setAutoAdapt(false);
						return;
					}
					return;
				} else {
					this.targetReachedTime = null;
				}

				// Proportional step adjustment (SILKY SMOOTH)
				var pGain = 0.0001;
				var adjustment = diff * pGain;

				// Clamp step size for comfortable ramping
				var minAdj = 0.0002; // Very tiny for precision
				if (Math.abs(adjustment) < minAdj) adjustment = (diff > 0) ? minAdj : -minAdj;

				var maxAdj = 0.01; // Max 1% volume shift per poll for stability
				if (Math.abs(adjustment) > maxAdj) adjustment = (diff > 0) ? maxAdj : -maxAdj;

				var newVol = Math.max(0, Math.min(1, currentVol + adjustment));
				if (Math.abs(newVol - currentVol) > 0.00005) {
					window.setVolume(newVol);
				}
			}
		};

		// Initialize presets when DOM is ready
		function initializePresets() {
			console.log('Initializing presets...');

			var createBtn = document.getElementById('create-preset-button');
			var saveBtn = document.getElementById('preset-save-button');
			var cancelBtn = document.getElementById('preset-cancel-button');
			var dialog = document.getElementById('preset-dialog');

			if (!createBtn) {
				console.log('Create button not found');
				return;
			}

			console.log('Buttons found, setting up handlers...');

			// Create global handler functions
			window.handleCreatePreset = function (e) {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				console.log('Create preset clicked');
				try {
					if (typeof PresetsManager !== 'undefined' && PresetsManager.showCreateDialog) {
						PresetsManager.showCreateDialog();
					} else {
						console.error('PresetsManager not available');
						alert('Presets system not loaded. Please refresh the page.');
					}
				} catch (err) {
					console.error('Error in create button:', err);
					alert('Error: ' + err.message);
				}
				return false;
			};

			window.handleSavePreset = function (e) {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				console.log('Save preset clicked');
				try {
					if (typeof PresetsManager !== 'undefined' && PresetsManager.savePresetFromDialog) {
						PresetsManager.savePresetFromDialog();
					} else {
						alert('Presets system not loaded.');
					}
				} catch (err) {
					console.error('Error in save button:', err);
					alert('Error saving: ' + err.message);
				}
				return false;
			};

			window.handleCancelPreset = function (e) {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				console.log('Cancel clicked');
				try {
					if (typeof PresetsManager !== 'undefined' && PresetsManager.hideCreateDialog) {
						PresetsManager.hideCreateDialog();
					}
				} catch (err) {
					console.error('Error in cancel button:', err);
				}
				return false;
			};

			window.handleExportPresets = function (e) {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				console.log('Export clicked');
				try {
					if (typeof PresetsManager !== 'undefined' && PresetsManager.exportPresetsAsCode) {
						PresetsManager.exportPresetsAsCode();
					} else {
						alert('Presets system not loaded.');
					}
				} catch (err) {
					console.error('Error in export button:', err);
					alert('Error: ' + err.message);
				}
				return false;
			};

			window.handleImportPresets = function (e) {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				console.log('Import clicked');
				try {
					if (typeof PresetsManager !== 'undefined' && PresetsManager.importPresetsFromCode) {
						var code = prompt('Paste the preset code here (from user-presets.js or DefaultPresets array):');
						if (code && code.trim()) {
							PresetsManager.importPresetsFromCode(code);
						}
					} else {
						alert('Presets system not loaded.');
					}
				} catch (err) {
					console.error('Error in import button:', err);
					alert('Error: ' + err.message);
				}
				return false;
			};

			// Set up button handlers directly (backup)
			if (createBtn) {
				createBtn.onclick = window.handleCreatePreset;
			}

			if (saveBtn) {
				saveBtn.onclick = window.handleSavePreset;
			}

			if (cancelBtn) {
				cancelBtn.onclick = window.handleCancelPreset;
			}

			// Close dialog on outside click
			if (dialog) {
				dialog.onclick = function (e) {
					if (e.target === dialog) {
						PresetsManager.hideCreateDialog();
					}
				};

				// Keyboard support for dialog
				var nameInput = document.getElementById('preset-name-input');
				if (nameInput) {
					nameInput.addEventListener('keydown', function (e) {
						if (e.key === 'Enter') {
							e.preventDefault();
							PresetsManager.savePresetFromDialog();
						} else if (e.key === 'Escape') {
							PresetsManager.hideCreateDialog();
						}
					});
				}
			}

			// Render presets on load
			setTimeout(function () {
				PresetsManager.renderPresets();
				if (typeof PhyphoxManager !== 'undefined') {
					PhyphoxManager.init();
				}
			}, 100);

			// Device selector - save preference
			var deviceSelect = document.getElementById('current-device-select');
			var customDeviceInput = document.getElementById('custom-device-name');

			if (deviceSelect && customDeviceInput) {
				// Load saved device preference
				var savedDevice = localStorage.getItem('selectedDevice');
				var savedCustomDevice = localStorage.getItem('customDeviceName');

				if (savedDevice) {
					deviceSelect.value = savedDevice;
					if (savedDevice === 'other') {
						customDeviceInput.style.display = 'inline-block';
						if (savedCustomDevice) {
							customDeviceInput.value = savedCustomDevice;
						}
					}
				}

				deviceSelect.onchange = function () {
					var deviceValue = this.value;
					localStorage.setItem('selectedDevice', deviceValue);

					// Show/hide custom device input
					if (deviceValue === 'other') {
						customDeviceInput.style.display = 'inline-block';
						setTimeout(function () {
							customDeviceInput.focus();
						}, 10);
					} else {
						customDeviceInput.style.display = 'none';
						customDeviceInput.value = '';
						localStorage.removeItem('customDeviceName');
					}
				};

				// Save custom device name
				customDeviceInput.onchange = function () {
					if (deviceSelect.value === 'other') {
						localStorage.setItem('customDeviceName', this.value);
					}
				};

				customDeviceInput.onblur = function () {
					if (deviceSelect.value === 'other') {
						localStorage.setItem('customDeviceName', this.value);
					}
				};
			} else {
				console.log('Device selector elements not found, will retry...');
			}

			// Export presets button
			var exportBtn = document.getElementById('export-presets-button');
			if (exportBtn) {
				exportBtn.onclick = window.handleExportPresets;
			}

			// Import presets button
			var importBtn = document.getElementById('import-presets-button');
			if (importBtn) {
				importBtn.onclick = window.handleImportPresets;
			}

			console.log('Presets buttons initialized successfully');
		}

		// Initialize when DOM is ready - wait for tone generator to load first
		(function () {
			function tryInit() {
				// Check if required elements exist
				var createBtn = document.getElementById('create-preset-button');
				if (!createBtn) {
					console.log('Buttons not found, retrying...');
					setTimeout(tryInit, 100);
					return;
				}

				// Check if PresetsManager is defined
				if (typeof PresetsManager === 'undefined') {
					console.log('PresetsManager not defined yet, retrying...');
					setTimeout(tryInit, 100);
					return;
				}

				console.log('Initializing presets system...');
				// All ready, initialize
				initializePresets();
			}

			// Try multiple initialization points
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', function () {
					console.log('DOMContentLoaded fired');
					setTimeout(tryInit, 300);
				});
			} else {
				console.log('DOM already loaded');
				setTimeout(tryInit, 300);
			}

			// Backup with window.onload
			window.addEventListener('load', function () {
				console.log('Window load fired');
				setTimeout(tryInit, 200);
			});

			// Also try immediately if script is at end of body
			setTimeout(tryInit, 500);
		})();
	</script>

	<script>
		/**
		 * ========================================================
		 * MASTER TONE ENGINE & SYNC CONTROLLER
		 * ========================================================
		 * Unified system for Stereo, Peak Detection, and Initialization
		 */

		window.stereoMode = false;
		window.freqL = window.freqL || 440;
		window.freqR = window.freqR || 440;
		window._editingL = false;
		window._editingR = false;
		window._updatingL = false;
		window._updatingR = false;
		
		// PATCH window.setFreq to NOT override stereo inputs when stereo mode is ON
		(function() {
			var originalSetFreq = window.setFreq;
			window.setFreq = function(f) {
				// When stereo mode is ON, ignore main slider updates - only stereo inputs control frequency
				if (window.stereoMode) {
					// Still update sliderFreq for display, but DON'T update the actual oscillators
					window.sliderFreq = f;
					if (window.freqReadout) window.freqReadout.update();
					// DO NOT call tones.current.setFreq - let the stereo inputs control the oscillators
					return true;
				}
				// Normal mode - use original function
				return originalSetFreq.call(this, f);
			};
		})();

		(function () {
			// Deep patch of the core Tones engine
			function applyMasterPatch() {
				if (!window.tones || !window.tones.current) {
					setTimeout(applyMasterPatch, 100);
					return;
				}

				const tone = window.tones.current;

				// 1. DUAL OSCILLATOR ENGINE
				const originalInit = tone.initOscillator;
				tone.initOscillator = function () {
					// Safety cleanup of any orphans
					if (this.oscL) { try { this.oscL.stop(); } catch (e) { } }
					if (this.oscR) { try { this.oscR.stop(); } catch (e) { } }
					this.oscL = this.oscR = null;

					if (window.stereoMode && this.channels === 2) {
						this.oscL = tones.context.createOscillator();
						this.oscR = tones.context.createOscillator();

						this.oscL.connect(this.leftGainNode);
						this.oscR.connect(this.rightGainNode);

						// ACOUSTIC SAFETY: Scale gain to 0.6 per channel to prevent clipping in stereo
						// (1.0 + 1.0 = 2.0 = distortion/ear splitting)
						this.leftGainNode.gain.setTargetAtTime(0.6 * Math.min(1, 1 - this.balance), tones.context.currentTime, 0.05);
						this.rightGainNode.gain.setTargetAtTime(0.6 * Math.min(1, 1 + this.balance), tones.context.currentTime, 0.05);

						this.oscL.frequency.value = window.freqL;
						this.oscR.frequency.value = window.freqR;
						this.oscL.type = this.oscR.type = this.type;
						this.oscillator = this.oscL;
					} else {
						// MONO RESET: Ensure full gain is restored
						if (this.leftGainNode) this.leftGainNode.gain.setTargetAtTime(Math.min(1, 1 - this.balance), tones.context.currentTime, 0.05);
						if (this.rightGainNode) this.rightGainNode.gain.setTargetAtTime(Math.min(1, 1 + this.balance), tones.context.currentTime, 0.05);
						originalInit.call(this);
					}
				};

				const originalPlay = tone.play;
				tone.play = function (t0) {
					if (window.stereoMode && this.channels === 2) {
						if (this.playing) return false;
						this.initOscillator();
						const t = t0 || tones.context.currentTime;
						if (this.oscL) this.oscL.start(t);
						if (this.oscR) this.oscR.start(t);
						this.playing = true;
						this.fadeGainNode.gain.setTargetAtTime(1, t, 0.05);
						return true;
					}
					return originalPlay.call(this, t0);
				};

				const originalStop = tone.stop;
				tone.stop = function (t0) {
					// FLALWESS CLEANUP: Stop EVERYTHING regardless of current mode
					if (this.oscL || this.oscR) {
						if (!this.playing) return false;
						const t = t0 || tones.context.currentTime;
						this.fadeGainNode.gain.setTargetAtTime(0, t, 0.05);
						const self = this;
						if (this.oscillatorStopTimeoutID) clearTimeout(this.oscillatorStopTimeoutID);
						this.oscillatorStopTimeoutID = setTimeout(() => {
							try { if (self.oscL) self.oscL.stop(); } catch (e) { }
							try { if (self.oscR) self.oscR.stop(); } catch (e) { }
							self.oscL = self.oscR = null;
							self.playing = false;
						}, 500);
						return true;
					}
					return originalStop.call(this, t0);
				};

				// 2. FLAWLESS SYNC LOGIC
				const originalSetFreq = tone.setFreq;
				tone.setFreq = function (f, chan) {
					if (window.stereoMode && this.channels === 2) {
						if (chan === 'L') {
							window.freqL = f;
							if (this.playing && this.oscL) this.oscL.frequency.setTargetAtTime(f, tones.context.currentTime, 0.02);
							// NEVER update input from setFreq - inputs are completely independent
						} else if (chan === 'R') {
							window.freqR = f;
							if (this.playing && this.oscR) this.oscR.frequency.setTargetAtTime(f, tones.context.currentTime, 0.02);
							// NEVER update input from setFreq - inputs are completely independent
						} else {
							// No channel specified - update both frequencies but NEVER the inputs when stereo mode is ON
							window.freqL = window.freqR = f;
							if (this.playing) {
								if (this.oscL) this.oscL.frequency.setTargetAtTime(f, tones.context.currentTime, 0.02);
								if (this.oscR) this.oscR.frequency.setTargetAtTime(f, tones.context.currentTime, 0.02);
							}
							// NEVER update inputs when stereo mode is ON - they are completely independent
							// Only update if stereo mode is OFF (from main slider)
							if (!window.stereoMode) {
								const inL = document.getElementById('freq-l-input');
								const inR = document.getElementById('freq-r-input');
								if (inL && document.activeElement !== inL && !inL.matches(':focus') && !window._editingL && !window._updatingL) inL.value = f.toFixed(1);
								if (inR && document.activeElement !== inR && !inR.matches(':focus') && !window._editingR && !window._updatingR) inR.value = f.toFixed(1);
							}
						}
					} else {
						window.freqL = window.freqR = f;
						// Only update inputs if stereo mode is OFF and inputs are not focused/being edited
						if (!window.stereoMode) {
							const inL = document.getElementById('freq-l-input');
							const inR = document.getElementById('freq-r-input');
							if (inL && document.activeElement !== inL && !inL.matches(':focus') && !window._editingL && !window._updatingL) inL.value = f.toFixed(1);
							if (inR && document.activeElement !== inR && !inR.matches(':focus') && !window._editingR && !window._updatingR) inR.value = f.toFixed(1);
						}
						originalSetFreq.call(this, f);
					}
				};

				// Initial sync call - only if stereo mode is OFF
				setTimeout(() => {
					if (window.sliderFreq && !window.stereoMode) { 
						syncUIInputs(window.sliderFreq); 
						window.freqReadout.update(); 
					}
				}, 100);
			}

			function syncUIInputs(f) {
				// Sync both inputs only when user is NOT actively typing in them AND stereo mode is OFF
				// When stereo mode is ON, inputs should be completely independent - NEVER sync them
				if (!window.stereoMode) {
					const inL = document.getElementById('freq-l-input');
					const inR = document.getElementById('freq-r-input');
					// Only update if input is not focused, not being edited, and not being updated
					if (inL && document.activeElement !== inL && !inL.matches(':focus') && !window._editingL && !window._updatingL) {
						inL.value = f.toFixed(1);
					}
					if (inR && document.activeElement !== inR && !inR.matches(':focus') && !window._editingR && !window._updatingR) {
						inR.value = f.toFixed(1);
					}
				}
				// When stereo mode is ON, DO NOTHING - inputs are completely independent
			}

			// Hook into main init process
			const originalWindowInit = window.init;
			window.init = function () {
				if (originalWindowInit) originalWindowInit.apply(this, arguments);
				setTimeout(applyMasterPatch, 50);
			};

			applyMasterPatch();
		})();
		
		// ISOLATE INPUT HANDLERS - Prevent any cross-updates
		(function() {
			function setupIsolatedHandlers() {
				var inL = document.getElementById('freq-l-input');
				var inR = document.getElementById('freq-r-input');
				
				if (!inL || !inR) {
					setTimeout(setupIsolatedHandlers, 100);
					return;
				}
				
				// Remove any existing handlers
				var newL = inL.cloneNode(true);
				var newR = inR.cloneNode(true);
				inL.parentNode.replaceChild(newL, inL);
				inR.parentNode.replaceChild(newR, inR);
				inL = newL;
				inR = newR;
				
				// LEFT INPUT - Completely isolated
				inL.addEventListener('input', function(e) {
					e.stopPropagation();
					e.stopImmediatePropagation();
					var v = parseFloat(this.value);
					if (!isNaN(v) && v >= 1 && v <= 20154) {
						window._updatingL = true;
						window.freqL = v;
						var t = window.tones;
						if (t && t.current) {
							// Always update via setFreq to ensure proper initialization
							t.current.setFreq(v, 'L');
							// Also directly update oscillator if it exists and is playing
							if (t.current.oscL) {
								if (t.current.playing) {
									t.current.oscL.frequency.setTargetAtTime(v, t.context.currentTime, 0.02);
								} else {
									// If not playing, set the frequency for when it starts
									t.current.oscL.frequency.value = v;
								}
							}
						}
						window._updatingL = false;
					}
				}, true);
				
				inL.addEventListener('change', function(e) {
					e.stopPropagation();
					e.stopImmediatePropagation();
					var v = parseFloat(this.value);
					if (!isNaN(v) && v >= 1 && v <= 20154) {
						window._updatingL = true;
						window.freqL = v;
						this.value = v.toFixed(1);
						window._updatingL = false;
					} else {
						this.value = (window.freqL || 440).toFixed(1);
					}
				}, true);
				
				inL.addEventListener('focus', function(e) {
					window._editingL = true;
				}, true);
				
				inL.addEventListener('blur', function(e) {
					window._editingL = false;
				}, true);
				
				// RIGHT INPUT - Completely isolated
				inR.addEventListener('input', function(e) {
					e.stopPropagation();
					e.stopImmediatePropagation();
					var v = parseFloat(this.value);
					if (!isNaN(v) && v >= 1 && v <= 20154) {
						window._updatingR = true;
						window.freqR = v;
						var t = window.tones;
						if (t && t.current) {
							// Always update via setFreq to ensure proper initialization
							t.current.setFreq(v, 'R');
							// Also directly update oscillator if it exists
							if (t.current.oscR) {
								if (t.current.playing) {
									t.current.oscR.frequency.setTargetAtTime(v, t.context.currentTime, 0.02);
								} else {
									// If not playing, set the frequency for when it starts
									t.current.oscR.frequency.value = v;
								}
							}
						}
						window._updatingR = false;
					}
				}, true);
				
				inR.addEventListener('change', function(e) {
					e.stopPropagation();
					e.stopImmediatePropagation();
					var v = parseFloat(this.value);
					if (!isNaN(v) && v >= 1 && v <= 20154) {
						window._updatingR = true;
						window.freqR = v;
						this.value = v.toFixed(1);
						window._updatingR = false;
					} else {
						this.value = (window.freqR || 440).toFixed(1);
					}
				}, true);
				
				inR.addEventListener('focus', function(e) {
					window._editingR = true;
				}, true);
				
				inR.addEventListener('blur', function(e) {
					window._editingR = false;
				}, true);
			}
			
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', setupIsolatedHandlers);
			} else {
				setupIsolatedHandlers();
			}
		})();

		// GLOBAL HELPERS
		window.toggleStereoMode = function (enabled) {
			const wasPlaying = window.tones && window.tones.playing;

			// HEARING PROTECTION: Gentle crossfade during switch
			if (wasPlaying) {
				if (window.tones.current && window.tones.current.fadeGainNode) {
					window.tones.current.fadeGainNode.gain.linearRampToValueAtTime(0, tones.context.currentTime + 0.2);
				}
				setTimeout(() => {
					performSwitch(enabled);
					if (window.tones.current && window.tones.current.fadeGainNode) {
						window.tones.current.fadeGainNode.gain.linearRampToValueAtTime(1, tones.context.currentTime + 0.2);
					}
				}, 250);
			} else {
				performSwitch(enabled);
			}

			function performSwitch(val) {
				window.stereoMode = val;

				// UI SYNC: Hide standard block, show Stereo panel
				const mainGroup = document.getElementById('main-freq-controls');
				const stereoInputs = document.getElementById('stereo-freq-inputs');
				const stereoBtn = document.getElementById('stereo-mode-btn');

				if (val) {
					if (mainGroup) mainGroup.style.display = 'none';
					if (stereoInputs) stereoInputs.style.display = 'inline-flex';
					if (stereoBtn) {
						stereoBtn.classList.add('active');
						stereoBtn.textContent = 'STOP STEREO';
						stereoBtn.style.background = '#8e420b';
						stereoBtn.style.color = '#fff';
					}
					// DISABLE main slider when stereo mode is ON
					var mainSlider = document.getElementById('slider');
					if (mainSlider && window.slider_jq) {
						window.slider_jq.slider('disable');
					}

					// Initialize both to same value when enabling stereo mode
					// But only update inputs if they're not currently focused
					window.freqL = window.freqR = window.sliderFreq || 440;
					const inL = document.getElementById('freq-l-input');
					const inR = document.getElementById('freq-r-input');
					// Use setTimeout to avoid conflicts with any ongoing input
					setTimeout(function() {
						if (inL && document.activeElement !== inL && !window._editingL && !window._updatingL) inL.value = window.freqL.toFixed(1);
						if (inR && document.activeElement !== inR && !window._editingR && !window._updatingR) inR.value = window.freqR.toFixed(1);
					}, 0);
				} else {
					if (mainGroup) mainGroup.style.display = 'inline-flex';
					if (stereoInputs) stereoInputs.style.display = 'none';
					if (stereoBtn) {
						stereoBtn.classList.remove('active');
						stereoBtn.textContent = 'STEREO ENGINE';
						stereoBtn.style.background = '';
						stereoBtn.style.color = '';
					}
					// ENABLE main slider when stereo mode is OFF
					var mainSlider = document.getElementById('slider');
					if (mainSlider && window.slider_jq) {
						window.slider_jq.slider('enable');
					}
				}

				// ACTIVATE CHANGE WITHOUT STOPPING ENGINE
				if (wasPlaying && window.tones && tones.current) {
					// Rebuild oscillators with current frequencies (preserve user-set values)
					if (window.stereoMode && tones.current.channels === 2) {
						var wasPlaying = tones.current.playing;
						if (wasPlaying) {
							tones.current.stop();
							setTimeout(function() {
								tones.current.initOscillator();
								tones.current.play();
							}, 100);
						}
					}
				}
			}
		};

		window.setFreqL = function (val, skipInputUpdate) {
			const f = parseFloat(val);
			if (!isNaN(f) && f >= 1 && f <= 20154) {
				window.freqL = f;
				if (window.tones && tones.current) {
					// Temporarily disable input updates when called from user input
					window._updatingFromInput = true;
					tones.current.setFreq(f, 'L');
					window._updatingFromInput = false;
				}
			}
		};

		window.setFreqR = function (val, skipInputUpdate) {
			const f = parseFloat(val);
			if (!isNaN(f) && f >= 1 && f <= 20154) {
				window.freqR = f;
				if (window.tones && tones.current) {
					// Temporarily disable input updates when called from user input
					window._updatingFromInput = true;
					tones.current.setFreq(f, 'R');
					window._updatingFromInput = false;
				}
			}
		};

		window.setVolume = function (v) {
			if (v < 0 || v > 1) return;
			window.volume = v;
			if (window.tones && tones.current) {
				tones.current.setVolume(v);
			}
			const readout = document.getElementById('volume-readout');
			if (readout) {
				const pct = (v * 100).toFixed(v === Math.round(v * 100) / 100 ? 0 : 2);
				readout.innerHTML = pct + '%';
			}
			if (window.volSlider) { $(window.volSlider).slider('value', v * 100); }
		};
	</script>

	<script>
		if (getCookie("ab-otgbanad") !== "y") { //user removed ads (does not include adblock)
			window.AD_PLACEMENT = 2;
			window.AD_FREE = false;
			document.write('<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"><\/script>');
		} else window.AD_FREE = true;
	</script>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-1DSZFLKR1X"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());
		gtag('config', 'G-1DSZFLKR1X', { cookie_domain: 'www.szynalski.com', cookie_path: '/tone-generator' });
		/*!
			 * jQuery UI Touch Punch 0.2.3
			 * Copyright 2011–2014, Dave Furfero
			 * Dual licensed under the MIT or GPL Version 2 licenses.
			 */
		!function (a) { function f(a, b) { if (!(a.originalEvent.touches.length > 1)) { a.preventDefault(); var c = a.originalEvent.changedTouches[0], d = document.createEvent("MouseEvents"); d.initMouseEvent(b, !0, !0, window, 1, c.screenX, c.screenY, c.clientX, c.clientY, !1, !1, !1, !1, 0, null), a.target.dispatchEvent(d) } } if (a.support.touch = "ontouchend" in document, a.support.touch) { var e, b = a.ui.mouse.prototype, c = b._mouseInit, d = b._mouseDestroy; b._touchStart = function (a) { var b = this; !e && b._mouseCapture(a.originalEvent.changedTouches[0]) && (e = !0, b._touchMoved = !1, f(a, "mouseover"), f(a, "mousemove"), f(a, "mousedown")) }, b._touchMove = function (a) { e && (this._touchMoved = !0, f(a, "mousemove")) }, b._touchEnd = function (a) { e && (f(a, "mouseup"), f(a, "mouseout"), this._touchMoved || f(a, "click"), e = !1) }, b._mouseInit = function () { var b = this; b.element.bind({ touchstart: a.proxy(b, "_touchStart"), touchmove: a.proxy(b, "_touchMove"), touchend: a.proxy(b, "_touchEnd") }), c.call(b) }, b._mouseDestroy = function () { var b = this; b.element.unbind({ touchstart: a.proxy(b, "_touchStart"), touchmove: a.proxy(b, "_touchMove"), touchend: a.proxy(b, "_touchEnd") }), d.call(b) } } }(jQuery);
	</script>
</head>

<body>
	<script>writeCookieMessage("privacy.htm");</script>

	<svg xmlns="http://www.w3.org/2000/svg" style="display: none">
		<symbol id="svg-Lspeaker-icon" viewBox="0 0 40 38">
			<svg version="1.1" xmlns="http://www.w3.org/2000/svg">
				<g transform="translate(-84.748 -76.596)">
					<g transform="matrix(-.28222 0 0 .28222 848.8 -82.759)" fill="inherit">
						<path d="m2645.1 696.21v-131.56l-32.764 33.843h-41.068l0.028 63.916 41.054-0.0201z"
							fill-rule="evenodd" />
						<path transform="matrix(.9375 0 0 .9375 -5.8967 -8.2345)"
							d="m2852 645.99-9.1192 8.916c6.4339 6.5121 10.396 15.473 10.396 25.402 0 10.415-4.3627 19.759-11.361 26.334l9.125 8.9199c9.276-8.9155 15.072-21.426 15.072-35.254 0-13.348-5.3964-25.473-14.113-34.318z"
							fill-rule="evenodd" />
						<path transform="matrix(.9375 0 0 .9375 -5.8967 -8.2345)"
							d="m2872 626.46-9.1211 8.916c11.358 11.549 18.361 27.396 18.361 44.926 0 18.014-7.3974 34.248-19.314 45.869l9.127 8.9199c14.198-13.957 23.023-33.36 23.023-54.789 0-20.947-8.4354-39.96-22.076-53.842z"
							color="#000000" color-rendering="auto" dominant-baseline="auto" image-rendering="auto"
							shape-rendering="auto" solid-color="#000000" />
					</g>
				</g>
			</svg>
		</symbol>
		<symbol id="svg-Rspeaker-icon" viewBox="0 0 40 38">
			<use xlink:href="#svg-Lspeaker-icon" width="40" transform="translate(40 0) scale(-1,1)" />
		</symbol>
		<symbol id="svg-balance-icon" viewBox="0 0 92 38">
			<use xlink:href="#svg-Lspeaker-icon" width="40" />
			<use xlink:href="#svg-Rspeaker-icon" width="40" transform="translate(48 0)" />
		</symbol>
	</svg>

	<div id=wrapper>
		<h1>Online Tone Generator</h1>

		<div id="generator-ui">

			<button class=button id="play-button" title="Play/Stop [Space]" tabindex=10>Play</button>
			<span id="play-indicator" class="stopped"></span>

			<a class=support-link href="#support">Support this site &raquo;</a>

			<div id="slider" style="margin: 40px 0px 18px 0px"></div>
			<div class="controls">
				<span class=control-group>
					<label id="volume-slider-label"></label>
					<span id="volume-slider"></span>
					<span id="volume-readout" style="margin-right: 20px"></span>
					<button id="balance-control" title="balance" tabindex=40><svg viewBox="0 0 92 38">
							<use id="balance-control-L-speaker-icon" xlink:href="#svg-Lspeaker-icon" width="40" />
							<use id="balance-control-R-speaker-icon" xlink:href="#svg-Rspeaker-icon" width="40"
								transform="translate(48 0)" />
						</svg></button>
					<span class=separator style="margin-right: 55px"></span>
				</span>
				<span class="control-group stereo-controls"
					style="border: 2px solid #a55f2b; padding: 4px 12px; border-radius: 6px; background: rgba(165, 95, 43, 0.1); display: inline-flex; align-items: center; gap: 12px; transition: all 0.3s ease;">
					<button id="stereo-mode-btn" class="button" onclick="window.toggleStereoMode(!window.stereoMode)"
						title="Toggle Dual-Channel Stereo"
						style="font-weight: bold; padding: 4px 12px; min-width: 130px; font-size: 13px; text-transform: uppercase;">Stereo
						Engine</button>

					<span id="stereo-freq-inputs"
						style="display: none; gap: 15px; align-items: center; border-left: 1px solid rgba(165, 95, 43, 0.3); padding-left: 15px;">
						<span style="display: inline-flex; align-items: center; gap: 5px;">
							<label style="font-size: 11px; color: #7a3400; font-weight: bold;">LEFT</label>
							<input type="number" id="freq-l-input" step="0.1" min="1" max="20154" value="440" data-channel="L" name="freq-l-input"
								style="width: 85px; padding: 5px; border: 1px solid #a55f2b; border-radius: 3px; font-size: 14px; font-family: 'Open Sans', sans-serif; font-weight: bold; text-align: center; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);">
						</span>
						<span style="display: inline-flex; align-items: center; gap: 5px;">
							<label style="font-size: 11px; color: #7a3400; font-weight: bold;">RIGHT</label>
							<input type="number" id="freq-r-input" step="0.1" min="1" max="20154" value="440" data-channel="R" name="freq-r-input"
								style="width: 85px; padding: 5px; border: 1px solid #a55f2b; border-radius: 3px; font-size: 14px; font-family: 'Open Sans', sans-serif; font-weight: bold; text-align: center; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);">
						</span>
					</span>
				</span>
				<span class=control-group id="main-freq-controls">
					<button class="small-button" id="octave-down-button" title="− 1 octave (frequency ÷ 2)"
						style="margin-right: 10px" tabindex=60>×½</button>
					<button class="freq-button" id="freq-down-button" title="– 1 Hz [Shift+←]" tabindex=70></button>
					<span id="freq-readout" tabindex=80></span>
					<button class="freq-button" id="freq-up-button" title="+ 1 Hz [Shift+→]" tabindex=90></button>
					<button class="small-button" id="octave-up-button" title="+ 1 octave (frequency × 2)"
						style="margin-left: 10px;" tabindex=100>×2</button>
					<span class=separator></span>
				</span>
				<span class=control-group>
					<label id="note-selector-label"></label>
					<button name="note-selector" id="note-selector" title="note selector" style="width: 110px;"
						tabindex=110></button>
				</span>
				<span class=control-group style="margin-right: 0px">
					<button name="wave-selector" id="wave-selector" title="wave type selector"
						style="width: 31.5px; margin-right: 20px; padding-left: 5px;" tabindex=300></button>
					<button name="get-link" id="get-link" tabindex=310>Copy link</button>
				</span>
			</div>

		</div>

		<div id="presets-section">
			<h2>Presets</h2>

			<div id="device-selector"
				style="margin-bottom: 15px; padding: 10px; background-color: rgba(251, 196, 157, 0.3); border-radius: 3px; border: solid 1px rgba(165, 95, 43, 0.3);">
				<label style="font-weight: 600; font-size: 13px; color: #7a3400; margin-right: 10px;">Your
					Device:</label>
				<select id="current-device-select"
					onchange="var inp=document.getElementById('custom-device-name');if(this.value==='other'){inp.style.display='inline-block';setTimeout(function(){inp.focus();},10);}else{inp.style.display='none';inp.value='';}if(typeof localStorage!=='undefined')localStorage.setItem('selectedDevice',this.value);"
					style="padding: 6px; border: solid 1px #a55f2b; border-radius: 3px; background-color: #fff; font-family: 'Open Sans', sans-serif; font-size: 14px; margin-right: 10px;">
					<option value="">Select your device...</option>
					<option value="mobile">Mobile (Android 100% volume)</option>
					<option value="pc">PC (63% system volume)</option>
					<option value="other">Other (specify)</option>
				</select>
				<input type="text" id="custom-device-name" placeholder="Enter device name..."
					onchange="if(typeof localStorage!=='undefined'&&document.getElementById('current-device-select').value==='other')localStorage.setItem('customDeviceName',this.value);"
					onblur="if(typeof localStorage!=='undefined'&&document.getElementById('current-device-select').value==='other')localStorage.setItem('customDeviceName',this.value);"
					style="padding: 6px; border: solid 1px #a55f2b; border-radius: 3px; background-color: #fff; font-family: 'Open Sans', sans-serif; font-size: 14px; display: none; width: 200px; box-sizing: border-box;">
			</div>

			<div id="presets-controls">
				<button type="button" class="button" id="create-preset-button" tabindex=320
					onclick="window.handleCreatePreset && window.handleCreatePreset(event)">Create Preset</button>
				<button type="button" class="button" id="export-presets-button" tabindex=321
					style="font-size: 12px; padding: 6px 12px; margin-left: 8px;"
					onclick="window.handleExportPresets && window.handleExportPresets(event)">Export to Code</button>
				<button type="button" class="button" id="import-presets-button" tabindex=322
					style="font-size: 12px; padding: 6px 12px; margin-left: 8px;"
					onclick="window.handleImportPresets && window.handleImportPresets(event)">Import from Code</button>
			</div>
			<div id="presets-list"></div>
			<div id="preset-dialog" style="display: none;">
				<div class="preset-dialog-content">
					<h3>Save Preset</h3>
					<div class="preset-form">
						<label>Preset Name:</label>
						<input type="text" id="preset-name-input" placeholder="Enter preset name" maxlength="50">
						<p style="font-size: 12px; color: #8e420b; margin-top: 10px;">This will save all current
							settings: frequency, volume, device type, and other values.</p>
					</div>
					<div class="preset-dialog-buttons">
						<button type="button" class="button" id="preset-save-button"
							onclick="window.handleSavePreset && window.handleSavePreset(event)">Save</button>
						<button type="button" class="button" id="preset-cancel-button"
							onclick="window.handleCancelPreset && window.handleCancelPreset(event)">Cancel</button>
					</div>
				</div>
			</div>
		</div>

		<div id="phyphox-section">
			<h2>Phyphox Magnetometer Link</h2>

			<div class="phyphox-controls-container">
				<!-- Connection Panel -->
				<div class="phyphox-panel">
					<h3>Connection Settings</h3>
					<div class="phyphox-input-group">
						<label>Connection Code (3 numbers in app):</label>
						<div class="phyphox-input-row" style="align-items: center; display: flex; gap: 8px;">
							<input type="text" id="phyphox-code" placeholder="000" maxlength="3"
								style="font-size: 24px; font-weight: bold; text-align: center; width: 80px; flex: none; border: 1px solid #2980b9; border-radius: 3px; padding: 5px;">
							<button type="button" class="button" id="phyphox-connect-btn"
								onclick="PhyphoxManager.connect()" style="flex: 1; height: 45px;">Connect</button>
						</div>

						<div
							style="margin-top: 15px; border-top: 1px dashed rgba(41, 128, 185, 0.3); padding-top: 10px;">
							<label style="font-size: 11px; opacity: 0.8;">IP Prefix (only change if needed):</label>
							<input type="text" id="phyphox-prefix" value="192.168.1."
								style="font-size: 12px; padding: 4px; width: 100%; box-sizing: border-box; background: transparent; border: none; border-bottom: 1px solid #2980b9;">
						</div>

						<div id="phyphox-status" class="phyphox-status status-disconnected">Disconnected</div>
					</div>
					<p style="font-size: 11px; color: #5d6d7e; margin-top: 10px;">
						1. Open the <b>Magnetometer Link</b> app.<br>
						2. Enter the <b>Connection Code</b> (3 numbers) above.<br>
						3. Click <b>Connect</b>.
					</p>
				</div>

				<!-- Control Panel -->
				<div class="phyphox-panel">
					<h3>Magnetism Control</h3>

					<div class="phyphox-display"
						style="display: flex; justify-content: space-around; align-items: center;">
						<div>
							<div class="mt-value"><span id="current-mt-display">0.0</span></div>
							<div class="mt-label">Current (μT)</div>
						</div>
						<div style="border-left: 1px solid #ddd; height: 40px;"></div>
						<div>
							<div class="mt-value" style="color: #e67e22;"><span id="peak-mt-display">0.0</span></div>
							<div class="mt-label" style="color: #d35400;">PEAK (μT)</div>
						</div>
					</div>

					<div class="phyphox-input-group">
						<label>Target Magnetism (μT):</label>
						<input type="number" id="target-mt" placeholder="e.g. 100"
							onchange="PhyphoxManager.setTarget(this.value)"
							style="width: 100%; padding: 8px; border: solid 1px #2980b9; border-radius: 3px; box-sizing: border-box;">
					</div>

					<div id="auto-adapt-container" class="auto-adapt-toggle" onclick="PhyphoxManager.toggleAutoAdapt()">
						<input type="checkbox" id="auto-adapt-checkbox"
							onclick="event.stopPropagation(); PhyphoxManager.toggleAutoAdapt()">
						<span id="auto-adapt-label">Auto-Adapt: OFF</span>
					</div>

					<p style="font-size: 11px; color: #5d6d7e; margin-top: 10px;">
						When Auto-Adapt is ON, the volume will adjust automatically to maintain the target microtesla
						reading.
					</p>
				</div>
			</div>
		</div>

		<div id="otgbanad-2" class="banad" style="display: none">
			<div class="ad-banner-blocker"></div>
			<div class="ad-banner-remove-msg">
				<i>Poof!</i> You won’t see this ad (either now or on your subsequent visits). Please consider
				<a href="#support">supporting the generator directly</a>. <i>Thanks!</i>
			</div>
			<div class="ad-banner-adblock-msg">
				<i>Hmmm...</i> An ad should be here, but it didn’t load. Please consider
				<a href="#support">supporting this site directly</a>. <i>Thanks!</i>
			</div>
			<ins style="display:block" data-ad-client="ca-pub-9138061171980132" data-ad-slot="9335466564"
				data-ad-format="horizontal"></ins>
			<!--must be horizontal, else adsense will sometimes load a huge squarish unit on desktop-->
			<div class="ad-remove-ui">
				<a class="ad-remove-link" href="javascript:;" onclick="adUnits.getUnit('otgbanad-2').remove(90)"><span
						class=ui-link-icon>⌧</span> <span class=ui-link-label>Remove ad and don’t show it
						again</span></a>
			</div>
		</div>
		<script>
			var container = document.getElementById("otgbanad-2");
			if (AD_FREE || AD_PLACEMENT != 2) {
				//container.style.height = "auto";
				//container.querySelector(".ad-remove-ui").style.display = "none";
			} else {
				container.style.display = "block";
				var ins = container.querySelector("ins");
				ins.className = "adsbygoogle example";
				adUnits.add("otgbanad-2");
				(adsbygoogle = window.adsbygoogle || []).push({});
			}
		</script>

		<div class=warning>
			<strong>You can damage your hearing or your speakers if you play tones at extreme volumes.</strong>
			People can’t hear sounds &lt; 20 Hz and &gt; 10,000 Hz very well. If you turn up the volume on your device
			to compensate,
			you could expose yourself to harmful sound levels and your speakers to harmful currents.
			To be safe, note the volume level that allows you to listen to a 1,000 Hz tone without discomfort and do not
			stray too far
			above this level, even if you can’t hear much – especially in the high range, where your hearing is the most
			fragile.
		</div>

		<h2>Instructions</h2>
		<p>
			To play a constant tone, click <span class=button-name>Play</span> or press <kbd>Space</kbd>.
		</p>
		<p>
			To change the frequency, drag the slider or press <kbd>←</kbd> <kbd>→</kbd> (arrow keys).
			To adjust the frequency by 1 Hz, use the
			<span class=image-freq-down></span> <span class=image-freq-up></span>
			buttons or press <kbd>Shift + ←</kbd> and <kbd>Shift + →</kbd>.
			To adjust the frequency by 0.01 Hz, press <kbd>Ctrl + ←</kbd> and <kbd>Ctrl + →</kbd>;
			to adjust it by 0.001 Hz, press <kbd>Ctrl + Shift + ←</kbd> and <kbd>Ctrl + Shift+ →</kbd>
			To halve/double the frequency (go down/up one octave), click
			<span class=button-name>×½</span> and <span class=button-name>×2</span>.
		</p>
		<p>
			To change the wave type from a sine wave (pure tone) to a square/triangle/sawtooth wave, click the
			<span class=button-name><span class=image-sine></span></span>
			button.
		</p>
		<p>
			You can mix tones by opening the Online Tone Generator
			in several browser tabs.
		</p>

		<h2>What can I use this tone generator for?</h2>
		<p>
			Tuning instruments, science experiments (<i>what’s the resonant frequency of this wineglass?</i>), testing
			audio equipment
			(<i>how low does my subwoofer go?</i>), testing your hearing (<i>what’s the highest frequency you can hear?
				are there frequencies
				you can hear in only one ear?</i>).
		</p>
		<p>
			<b>Tinnitus frequency matching.</b>
			If you have pure-tone <a href="https://blog.szynalski.com/2010/12/24/tinnitus-tips/">tinnitus</a>, this
			online frequency generator can help you determine its frequency.
			Knowing your tinnitus frequency can enable you to better target masking sounds and
			<a href="https://plasticity.szynalski.com/">frequency discrimination training</a>.
			When you find a frequency that seems to match your tinnitus, make sure you check frequencies
			one octave higher (frequency × 2) and one octave lower (frequency × ½), as it is easy to confuse
			tones that are one octave apart.
		</p>
		<p>
			<b>Alzheimer’s disease.</b>
			Some scientists from MIT are seriously investigating the possibility that <a href="#40"
				onclick="setTonePropertiesFromHash('40,v1,b0,sine')">40 Hz tones</a>
			may reverse some of the molecular changes in the brains of Alzheimer’s patients.
			Initial studies on transgenic mice showed promising results, but (as is often the case) early-stage human
			trials paint
			a much murkier picture. Further studies are underway. Here’s a
			<a href="https://blog.szynalski.com/2018/03/40-hz-tone-alzheimers/">summary of the research so far</a> and a
			report from a user who
			tried 40 Hz therapy on his wife.
			(<i>Note that this tone generator is not a medical device – I don’t guarantee anything!</i>)
		</p>

		<h2>Comments</h2>
		<p>
			You can leave comments <a href="https://blog.szynalski.com/2012/08/29/online-tone-generator/">here</a>.
		</p>

		<h2 id="support">Support this site</h2>
		<p>
			If you use the Online Tone Generator and find it helpful, please support it with a little bit of money.
			Here’s the deal:
			My goal is to keep maintaining this site to make sure it stays compatible with
			current browser versions. Unfortunately, this takes a non-trivial amount of time (for example, figuring
			out an obscure browser bug can take many hours of work), which is a problem because
			I have to make a living. Donations from awesome, good-looking users like you buy me time to keep things
			running.
		</p>
		<p>
			So if you think this tone generator is worth it, please support it with some money to help keep it online.
			The amount is entirely up to you – I only ask for what <em>you</em> consider fair price for the value you’re
			getting.
			<em>Thanks!</em>
		</p>

		<form action="https://www.paypal.com/cgi-bin/webscr" method="post" class="support">
			<input type="hidden" name="cmd" value="_donations">
			<input type="hidden" name="business" value="4S47JETKM9C72">
			<input type="hidden" name="lc" value="US">
			<input type="hidden" name="item_name" value="Online Tone Generator">
			<input type="hidden" name="item_number" value="Online Tone Generator Support">
			<input type="hidden" name="no_shipping" value="1">
			<input type="hidden" name="enable_recurring_donations" value="2">
			<input type="hidden" name="currency_code" value="USD">
			<div style="display: inline-block">
				<button class="donate" type="submit" name="submit">Support this site now &raquo;</button>
				<div class="donate-tip">PayPal / credit card</div>
			</div>
		</form>

		<div id=footer>
			Created by <a href="https://blog.szynalski.com/about/">Tomasz P. Szynalski</a>
			<span class=sep style="margin: 0 3px; color: #ddd">|</span>
			<a href="https://blog.szynalski.com/2012/08/29/online-tone-generator/">Comments</a>
			<span class=sep style="margin: 0 3px; color: #ddd">|</span>
			<a href="privacy.htm">Privacy policy</a>
		</div>

	</div>
</body>

</html>